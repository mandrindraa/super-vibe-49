# Authentication System Architecture

## ğŸ—ï¸ System Architecture Diagram

\`\`\`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        User Browser                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   Login Page         â”‚      â”‚   Protected Pages    â”‚          â”‚
â”‚  â”‚  /auth/login         â”‚      â”‚   useAuthSession()   â”‚          â”‚
â”‚  â”‚                      â”‚      â”‚                      â”‚          â”‚
â”‚  â”‚ Email/Password Form  â”‚      â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚          â”‚
â”‚  â”‚ Google OAuth Button  â”‚      â”‚ â”‚ Get user data  â”‚  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ â”‚ from session   â”‚  â”‚          â”‚
â”‚         â”‚                      â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚          â”‚
â”‚         â”‚ signIn()            â”‚                      â”‚          â”‚
â”‚         â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                       â”‚ JWT Token in Cookie              â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                                  â”‚
                        â–¼                                  â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚           Next.js API Routes & Middleware                 â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚                                                             â”‚
        â”‚  /api/auth/[...nextauth]  â—„â”€â”€â”€ NextAuth.js Configuration  â”‚
        â”‚       â–¼                                                     â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
        â”‚  â”‚ Credentials      â”‚     â”‚ Google OAuth         â”‚        â”‚
        â”‚  â”‚ Provider         â”‚     â”‚ Provider             â”‚        â”‚
        â”‚  â”‚                  â”‚     â”‚                      â”‚        â”‚
        â”‚  â”‚ Email/Password   â”‚     â”‚ External: Google     â”‚        â”‚
        â”‚  â”‚ Validation       â”‚     â”‚ oauth2.googleapis.com        â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
        â”‚           â”‚                          â”‚                     â”‚
        â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
        â”‚                      â”‚                                     â”‚
        â”‚  /api/auth/signup    â”‚   Create JWT Token                 â”‚
        â”‚  â–²                   â–¼   Store in HTTP-only Cookie        â”‚
        â”‚  â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
        â”‚  â”‚         â”‚  NextAuth Callbacks  â”‚                       â”‚
        â”‚  â”‚         â”‚                      â”‚                       â”‚
        â”‚  â”‚         â”‚ signIn()    â”€â”€â”€â”€â”€â”€â–º  â”‚                       â”‚
        â”‚  â”‚         â”‚ jwt()       â”€â”€â”€â”€â”€â”€â–º  â”‚                       â”‚
        â”‚  â”‚         â”‚ session()   â”€â”€â”€â”€â”€â”€â–º  â”‚                       â”‚
        â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
        â”‚  â”‚                  â”‚                                     â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
        â”‚                                                             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                  Supabase                                  â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚                                                             â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
        â”‚  â”‚  auth.users     â”‚          â”‚   profiles      â”‚         â”‚
        â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚
        â”‚  â”‚ id (UUID)       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ id (FK)         â”‚         â”‚
        â”‚  â”‚ email           â”‚          â”‚ username        â”‚         â”‚
        â”‚  â”‚ encrypted_pwd   â”‚          â”‚ full_name       â”‚         â”‚
        â”‚  â”‚ user_metadata   â”‚          â”‚ avatar_url      â”‚         â”‚
        â”‚  â”‚ created_at      â”‚          â”‚ reputation_scoreâ”‚         â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ bio, website    â”‚         â”‚
        â”‚                               â”‚ badges (JSONB)  â”‚         â”‚
        â”‚                               â”‚ created_at      â”‚         â”‚
        â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
        â”‚                                                             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\`\`\`

## ğŸ”„ Authentication Flows

### Email/Password Login Flow

\`\`\`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User   â”‚
â”‚ Enters  â”‚
â”‚Credentials
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ signIn("credentials", {                 â”‚
â”‚   email: "user@example.com",            â”‚
â”‚   password: "password123"                â”‚
â”‚ })                                      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NextAuth Credentials Provider           â”‚
â”‚ authorize() method                      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase Auth                           â”‚
â”‚ signInWithPassword()                    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â–º Validate credentials
     â”œâ”€â–º Check user exists
     â””â”€â–º Get auth token

     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Query profiles table                    â”‚
â”‚ Get user profile data                   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Return User Object                      â”‚
â”‚ {                                       â”‚
â”‚   id, email, name, image, username      â”‚
â”‚ }                                       â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NextAuth Creates JWT Token              â”‚
â”‚ Encodes user data into token            â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Store Token in HTTP-only Cookie         â”‚
â”‚ Set-Cookie: next-auth.session-token=... â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Redirect to Home Page                   â”‚
â”‚ User is now logged in                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\`\`\`

### Google OAuth Flow

\`\`\`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Clicks â”‚
â”‚Google Buttonâ”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ signIn("google")                 â”‚
â”‚ Redirect to Google OAuth Screen  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Authenticates with Google   â”‚
â”‚ Grants Permissions               â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Google Returns                   â”‚
â”‚ - id                             â”‚
â”‚ - email                          â”‚
â”‚ - name                           â”‚
â”‚ - picture                        â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NextAuth signIn() Callback       â”‚
â”‚ Check if profile exists          â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â–º Profile Exists?
     â”‚   â””â”€ YES: Update with latest data
     â”‚
     â””â”€â–º NO: Create new profile
         â””â”€ Generate unique username
         â””â”€ Insert into profiles table

     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Create JWT Token                 â”‚
â”‚ with User Data                   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Store in HTTP-only Cookie        â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Redirect to Home                 â”‚
â”‚ User is logged in                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\`\`\`

## ğŸ” Data Flow Diagram

\`\`\`
Browser (Client)                 Server                         Database
    â”‚                              â”‚                              â”‚
    â”œâ”€ useAuthSession() â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º getServerSession() â”€â”€â”€â”€â”€â”€â”€â”€â–º JWT Token
    â”‚  (client hook)               (server utility)             (in cookie)
    â”‚                              â”‚                              â”‚
    â”‚                              â”œâ”€ Verify JWT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                              â”‚                              â”‚
    â”‚â—„â”€ Return User Data â—„â”€â”€â”€â”€â”€â”€ Get Fresh Data â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ profiles
    â”‚   (from JWT token)         (on each request)              table
    â”‚                              â”‚                              â”‚
    â”‚â—„â”€ Session Object â—„â”€â”€â”€â”€â”€â”€â”€â”€ Enrich JWT â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Fetch
    â”‚   {                        (jwt callback)                  user data
    â”‚     user: {...},           â”‚
    â”‚     expires: ...           â”‚
    â”‚   }                        â”‚
    â”‚                            â”‚
    â”‚â”€ signIn() request â”€â”€â”€â”€â”€â”€â”€â”€â–º NextAuth Handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Supabase
    â”‚                            â”‚                              Auth
    â”‚                            â”œâ”€â–º Validate Credentials
    â”‚                            â”‚
    â”‚â—„â”€ JWT Token â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Create JWT â—„â”€ Get User
    â”‚  (in cookie)             (jwt callback)  from Auth
    â”‚                            â”‚
    â”‚                            â”œâ”€â–º Create Profile
    â”‚                            â””â”€â”€â–º profiles table
\`\`\`

## ğŸ“± Component Integration

\`\`\`
App Root
â”œâ”€â”€ SessionProvider (NextAuth)
â”‚   â””â”€â”€ Providers (from app/providers.tsx)
â”‚       â””â”€â”€ QueryClientProvider
â”‚           â””â”€â”€ ThemeProvider
â”‚               â””â”€â”€ Layout
â”‚                   â”œâ”€â”€ Header
â”‚                   â”‚   â””â”€â”€ UserMenu (useSession)
â”‚                   â”‚
â”‚                   â”œâ”€â”€ /auth/login
â”‚                   â”‚   â””â”€â”€ Login Form
â”‚                   â”‚       â”œâ”€â”€ Credentials Form
â”‚                   â”‚       â””â”€â”€ OAuth Buttons
â”‚                   â”‚
â”‚                   â”œâ”€â”€ /auth/signup (future)
â”‚                   â”‚   â””â”€â”€ Registration Form
â”‚                   â”‚       â””â”€â”€ Call /api/auth/signup
â”‚                   â”‚
â”‚                   â””â”€â”€ Protected Pages
â”‚                       â””â”€â”€ useAuthSession
â”‚                           â””â”€â”€ Guard access
\`\`\`

## ğŸ”Œ API Endpoints

\`\`\`
NextAuth Endpoints (automatic)
â”œâ”€â”€ GET  /api/auth/signin
â”œâ”€â”€ GET  /api/auth/callback/google
â”œâ”€â”€ GET  /api/auth/callback/credentials
â”œâ”€â”€ POST /api/auth/signin
â”œâ”€â”€ POST /api/auth/signout
â”œâ”€â”€ GET  /api/auth/session
â”œâ”€â”€ GET  /api/auth/csrf
â””â”€â”€ GET  /api/auth/providers

Custom Endpoints
â”œâ”€â”€ POST /api/auth/signup
â”‚   â”œâ”€â”€ Input: { email, password, fullName }
â”‚   â”œâ”€â”€ Returns: { user, message }
â”‚   â””â”€â”€ Creates: Supabase Auth + Profile
â”‚
â””â”€â”€ Protected Routes (require auth)
    â””â”€â”€ Use requireAuth() utility
\`\`\`

## ğŸ”‘ Token & Session Lifecycle

\`\`\`
Timeline          Event                       Storage
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T=0               User Login
                  JWT Created (30 days)
                  â”œâ”€ payload: {id, email, username, ...}
                  â”œâ”€ signed with NEXTAUTH_SECRET
                  â””â”€ expires: T + 30 days

                  Token stored in cookie
                  â”œâ”€ HTTP-only
                  â”œâ”€ Secure (HTTPS)
                  â””â”€ SameSite: Lax
                                               Cookie Storage

T=1min            Request to Protected Page
                  â”œâ”€ Cookie sent
                  â”œâ”€ JWT verified
                  â””â”€ jwt() callback updates
                      user data from DB       Database Query
                                               profiles table

T=30 days         Token Expires
                  â”œâ”€ JWT invalid
                  â”œâ”€ User logged out
                  â””â”€ Redirect to login        Clean Cookie

T=31 days         New Login Required          [User logs in again]
\`\`\`

## ğŸ›¡ï¸ Security Layers

\`\`\`
Layer 1: Transport
â”œâ”€â”€ HTTPS only (production)
â””â”€â”€ HTTP-only cookies (no JS access)

Layer 2: Token
â”œâ”€â”€ JWT signed with NEXTAUTH_SECRET
â”œâ”€â”€ Payload includes user.id
â”œâ”€â”€ Expires after 30 days
â””â”€â”€ Refreshed on new requests

Layer 3: Database
â”œâ”€â”€ Supabase Auth (encrypted passwords)
â”œâ”€â”€ Separate profiles table
â”œâ”€â”€ Row Level Security (RLS)
â””â”€â”€ Indexed lookups (username)

Layer 4: API
â”œâ”€â”€ CORS protection
â”œâ”€â”€ CSRF tokens (NextAuth)
â”œâ”€â”€ Input validation (Zod)
â””â”€â”€ Rate limiting (optional)

Layer 5: Code
â”œâ”€â”€ Type safety (TypeScript)
â”œâ”€â”€ No sensitive data in JWT
â”œâ”€â”€ Secure key usage
â””â”€â”€ Error handling (no data leaks)
\`\`\`

---

This architecture ensures:
âœ… Security (encrypted, tokens, RLS)
âœ… Scalability (JWT strategy)
âœ… Performance (indexed queries)
âœ… Maintainability (clear separation)
âœ… Type Safety (full TypeScript)
